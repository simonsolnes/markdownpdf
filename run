#!/bin/bash
if [ -z "$1" ] && [ ! -f "$1" ]; then
	echo -e "No argument supplied"
	exit
elif [ ! -f "$1" ]; then
	echo -e "File not found!"
	exit
fi

root="/tmp/markdownpdf/"
doc="doc.md"
file="$1"
new_file="${root}$(basename $doc .md).pdf"
new_pdf="$(basename $file .md).pdf"
header="latex_header.tex"

mkdir -p $root
rm -f ${root}*

cp $file "${root}$doc"
cp $LATEX_HEADER "${root}$header"
cp $MDPDF_SCRIPT "${root}mdpdf.py"

cd $root
echo "
from base/archlinux
run pacman -Sy
run pacman -S --noconfirm python3
run pacman -S --noconfirm texlive-most

workdir /home
env LATEX_HEADER=$header
cmd python3 mdpdf.py $doc
" > Dockerfile

sudo docker build -t mdpdf . > /dev/null
sudo docker run -it --rm -v $root:/home/ mdpdf > /dev/null

if [ ! -f "$new_file" ]; then
	echo -e "Pdf not generated!"
	exit
fi

cd - > /dev/null
mv "$new_file" $new_pdf
